import json
from typing import Any, Dict
from .base_agent import BaseAgent

class CriticAgent(BaseAgent):
    """
    AnalystAgentê°€ ì‘ì„±í•œ ë¦¬í¬íŠ¸ë¥¼ ê²€í† í•˜ì—¬,
    - ë‚´ìš©ì˜ íƒ€ë‹¹ì„±ì„ í‰ê°€í•˜ê³  ì˜¤ë¥˜ë‚˜ ëª¨í˜¸í•œ ë¶€ë¶„ì„ ì§€ì í•˜ë©°,
    - í•„ìš” ì‹œ 'ìˆ˜ì •'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ í¬í•¨í•œ í”¼ë“œë°±ê³¼ ìµœì¢… ë§¤ìˆ˜/ë§¤ë„/ë³´ë¥˜ ì˜ê²¬ì„ ìš”ì•½í•œ **ë§ˆí¬ë‹¤ìš´** ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    """
    def run(self, analyst_report: Dict[str, Any]) -> Dict[str, Any]:

        for ticker, report_data in analyst_report.items():
            print(f"\n[INFO] ğŸ“Œ CriticAgent: ë¶„ì„ ì‹œì‘ - ì¢…ëª©ì½”ë“œ = {ticker}")
            analysis_text = report_data
            print(f"[DEBUG] ğŸ“„ ì• ë„ë¦¬ìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ë‚´ìš©:\n{analysis_text}")
            
            # Few-shot ì˜ˆì‹œë¥¼ í¬í•¨í•œ í”„ë¡¬í”„íŠ¸ ì˜ˆì‹œ
            prompt = f"""
            ë‹¹ì‹ ì€ ê¸ˆìœµ ì• ë„ë¦¬ìŠ¤íŠ¸ ë³´ê³ ì„œë¥¼ ê²€í† í•˜ëŠ” ì—­í• ì…ë‹ˆë‹¤.

            ì•„ë˜ ì¡°ê±´ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•´ ì£¼ì„¸ìš”:

            1. **ë³´ê³ ì„œ íƒ€ë‹¹ì„± í‰ê°€**: ì „ì²´ ë‚´ìš©ì„ ì½ê³ , ì˜ëª»ëœ ì •ë³´ë‚˜ ëª¨í˜¸í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ êµ¬ì²´ì ìœ¼ë¡œ ì§€ì í•´ ì£¼ì„¸ìš”.
            2. **ìˆ˜ì • ìš”ì²­**:
            - ë§Œì•½ ë³´ê³ ì„œì— ìˆ˜ì •í•  ë¶€ë¶„(ì˜¤ë¥˜, ì¶”ê°€ì  ê·¼ê±° í•„ìš” ë“±)ì´ ìˆë‹¤ë©´, ìµœì¢… ë§ˆí¬ë‹¤ìš´ ë³´ê³ ì„œ ì–´ë”˜ê°€ì— ë°˜ë“œì‹œ `ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”`ë¼ëŠ” ë¬¸êµ¬ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”.
            - ìˆ˜ì •ì´ í•„ìš” ì—†ë‹¤ë©´, ì ˆëŒ€ë¡œ `ìˆ˜ì • ìš”ì²­`ì´ë¼ëŠ” ë‹¨ì–´ ìì²´ë¥¼ ì“°ì§€ ë§ˆì„¸ìš”.
            3. **ìµœì¢… ë§¤ìˆ˜/ë§¤ë„/ë³´ë¥˜ ì˜ê²¬**:
            - ë§¤ìˆ˜ ì˜ê²¬ì„ ì£¼ê³  ì‹¶ë‹¤ë©´, ë°˜ë“œì‹œ `ë§¤ìˆ˜ ìš”ì²­`ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”.
            - ë§¤ìˆ˜ ì™¸ì— ë§¤ë„/ë³´ë¥˜ ë“±ì˜ ì˜ê²¬ì„ ì£¼ê³  ì‹¶ë‹¤ë©´, `ë§¤ìˆ˜ ìš”ì²­`ì´ë¼ëŠ” ë‹¨ì–´ê°€ ì ˆëŒ€ ë“¤ì–´ê°€ì§€ ì•Šê²Œ í•´ì£¼ì„¸ìš”.
            4. ì¶œë ¥ì€ **ë§ˆí¬ë‹¤ìš´** í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.

            ---

            ## Few-shot Examples

            ì•„ë˜ëŠ” ì…ë ¥ ë¦¬í¬íŠ¸(ë¶„ì„ ì´ˆì•ˆ)ì™€ ìµœì¢… ì¶œë ¥(ê²€í†  ê²°ê³¼) ì˜ˆì‹œì…ë‹ˆë‹¤.

            ### ì˜ˆì‹œ 1
            **ì…ë ¥ ë¦¬í¬íŠ¸**:
            ì´ íšŒì‚¬ëŠ” ìµœê·¼ 3ë…„ê°„ ê¾¸ì¤€í•œ í‘ìë¥¼ ê¸°ë¡í–ˆìœ¼ë©°, ë¯¸ë˜ ì „ë§ ì—­ì‹œ ê¸ì •ì ì…ë‹ˆë‹¤. 
            í•˜ì§€ë§Œ ë§¤ì¶œ ì¶”ì´ì˜ ë³€ë™ ìš”ì¸ì— ëŒ€í•œ ë¶„ì„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. 
            ê·¸ë˜ë„ ë‚´ë…„ ì´ˆì— ì‹ ê·œ ì‚¬ì—…ì´ ë³¸ê²©í™”ë˜ë©´ ì‹¤ì ì´ í¬ê²Œ ì˜¤ë¥¼ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.

            markdown
            ë³µì‚¬
            í¸ì§‘
            **ì¶œë ¥(ìµœì¢… ë³´ê³ ì„œ)**:
            ì¢…ëª© ê²€í†  ê²°ê³¼
            íšŒì‚¬ì˜ ê³¼ê±° ì‹¤ì ì´ ê²¬ì¡°í•˜ë‹¤ëŠ” ì ì€ ê¸ì •ì ì…ë‹ˆë‹¤. 
            ë‹¤ë§Œ ë§¤ì¶œ ë³€ë™ ìš”ì¸ ë¶„ì„ì´ ëˆ„ë½ëœ ì ì´ ìˆì–´ í•´ë‹¹ ë¶€ë¶„ì„ ë³´ê°•í•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤. ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”

            ìµœì¢… ì˜ê²¬
            **ë§¤ìˆ˜ ìš”ì²­**
            íšŒì‚¬ì˜ ì‹ ê·œ ì‚¬ì—… ì§„ì¶œë¡œ ì¥ê¸°ì  ì„±ì¥ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.

            > **í•´ì„¤**:  
            > - ë§¤ì¶œ ë³€ë™ì— ëŒ€í•œ ì¶”ê°€ ë¶„ì„ì´ ëˆ„ë½ â†’ `ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”` ë¬¸êµ¬ í¬í•¨  
            > - ë§¤ìˆ˜ ì˜ê²¬ â†’ `ë§¤ìˆ˜ ìš”ì²­` ë¬¸êµ¬ í¬í•¨  

            ---

            ### ì˜ˆì‹œ 2
            **ì…ë ¥ ë¦¬í¬íŠ¸**:
            ì´ íšŒì‚¬ëŠ” ì˜¬í•´ í° ì ìë¥¼ ëƒˆìŠµë‹ˆë‹¤. ì¼ë¶€ ì‹ ì‚¬ì—…ì´ ì‹¤íŒ¨í•˜ì—¬ ì¬ë¬´êµ¬ì¡°ê°€ ë‚˜ë¹ ì¡ŒìŠµë‹ˆë‹¤. ë‹¨ê¸°ì ìœ¼ë¡œ ëšœë ·í•œ ë°˜ë“± ìš”ì¸ë„ ì—†ì–´ ë³´ì…ë‹ˆë‹¤.

            markdown
            ë³µì‚¬
            í¸ì§‘
            **ì¶œë ¥(ìµœì¢… ë³´ê³ ì„œ)**:
            ì¢…ëª© ê²€í†  ê²°ê³¼
            íšŒì‚¬ì˜ ì ì í­ì´ í¬ê³ , ì¬ë¬´êµ¬ì¡° ì·¨ì•½ì„±ì´ ë‹¨ê¸°ê°„ì— ê°œì„ ë  ì—¬ì§€ê°€ ì ì–´ ë³´ì…ë‹ˆë‹¤. í˜„ì¬ ë³´ê³ ì„œ ë‚´ìš©ì— í° ì˜¤ë¥˜ë‚˜ ì¶”ê°€ ë³´ì™„ì´ í•„ìš”í•œ ì‚¬í•­ì€ ì—†ì–´ ë³´ì…ë‹ˆë‹¤.

            ìµœì¢… ì˜ê²¬
            ë§¤ë„/ë³´ë¥˜
            ë‹¨ê¸°ì ì¸ íˆ¬ì ë§¤ë ¥ì€ ë‚®ë‹¤ê³  íŒë‹¨ë©ë‹ˆë‹¤.

            > **í•´ì„¤**:  
            > - íŠ¹ë³„íˆ ìˆ˜ì •í•  ë¶€ë¶„ì´ ì—†ìœ¼ë¯€ë¡œ `ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”` ë¬¸êµ¬ ì—†ìŒ  
            > - ë§¤ë„/ë³´ë¥˜ ì˜ê²¬ â†’ `ë§¤ìˆ˜ ìš”ì²­` ë¬¸êµ¬ ì—†ìŒ  

            ---

            ### ì˜ˆì‹œ 3
            **ì…ë ¥ ë¦¬í¬íŠ¸**:
            í˜„ì¬ ì›ìì¬ ê°€ê²© ë³€ë™ì„±ì— ëŒ€í•œ ê³ ë ¤ê°€ ë¯¸í¡í•©ë‹ˆë‹¤. ë˜í•œ ë§¤ì¶œ êµ¬ì¡°ë‚˜ ì‹œì¥ ì ìœ ìœ¨ì— ëŒ€í•œ ë°ì´í„°ê°€ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í–¥í›„ 2ë…„ê°„ ê¾¸ì¤€íˆ ë§¤ì¶œì•¡ì´ ì„±ì¥í•  ê²ƒìœ¼ë¡œ ê¸°ëŒ€ë©ë‹ˆë‹¤.

            **ì¶œë ¥(ìµœì¢… ë³´ê³ ì„œ)**:
            ì¢…ëª© ê²€í†  ê²°ê³¼
            ì‹œì¥ ì ìœ ìœ¨, ì›ìì¬ ê°€ê²© ë³€ë™ì„± ë“±ì— ëŒ€í•œ êµ¬ì²´ì  ë¶„ì„ì´ í•„ìš”í•´ ë³´ì…ë‹ˆë‹¤. ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”

            ìµœì¢… ì˜ê²¬
            ë§¤ë„/ë³´ë¥˜
            ë§¤ì¶œ ì¦ëŒ€ ê°€ëŠ¥ì„±ì€ ìˆìœ¼ë‚˜, í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì–´ ìˆì–´ ë³´ë¥˜ ì˜ê²¬ì„ ì œì‹œí•©ë‹ˆë‹¤.


            > - ëˆ„ë½ëœ ì •ë³´ë“¤ì´ ë§ìœ¼ë¯€ë¡œ ìˆ˜ì • í•„ìš” â†’ `ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”` ë¬¸êµ¬ í¬í•¨  
            > - ë³´ë¥˜ ì˜ê²¬ â†’ `ë§¤ìˆ˜ ìš”ì²­` ë¬¸êµ¬ ì—†ìŒ  

            ---

            ## ìš”ì²­ì‚¬í•­
            ì´ì œ ë‹¤ìŒ ì• ë„ë¦¬ìŠ¤íŠ¸ ë³´ê³ ì„œë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ„ì™€ ê°™ì€ í˜•ì‹ì— ë§ì¶° ìµœì¢… ë³´ê³ ì„œë¥¼ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.  
            (ì¡°ê±´: íƒ€ë‹¹ì„± í‰ê°€, ìˆ˜ì • í•„ìš” ì‹œ `ìˆ˜ì • ìš”ì²­ì„ í•´ì£¼ì„¸ìš”`, ë§¤ìˆ˜ ì‹œ `ë§¤ìˆ˜ ìš”ì²­`, ë§¤ìˆ˜ ì™¸ì—ëŠ” `ë§¤ìˆ˜ ìš”ì²­` ê¸ˆì§€)

            ### ì…ë ¥ ë¦¬í¬íŠ¸:
            {analysis_text}

            """
            response_format={
                            "type": "json_schema",
                            "json_schema": {
                                "name": "critic_response",
                                "strict": True,
                                "schema": {
                            "type" : "object",
                            "properties" : {
                                "critic" : {
                                    "type" : "string",
                                    "description" : "ë¦¬í¬íŠ¸ ê²€í†  ê²°ê³¼"
                                },
                                "opinion" : {
                                    "type" : "boolean",
                                    "description" : "ë§¤ìˆ˜ ì˜ê²¬, Trueë©´ ë§¤ìˆ˜, Falseë©´ ë§¤ë„/ë³´ë¥˜"
                                },
                                "revise" : {
                                    "type" : "boolean",
                                    "description" : "ìˆ˜ì • ìš”ì²­ ì—¬ë¶€, Trueë©´ ìˆ˜ì • ìš”ì²­, Falseë©´ ìˆ˜ì • ìš”ì²­ ì—†ìŒ"
                                }
                            }
                                }
                            }
                            }
            critic_response = self._call_llm_structured(prompt = prompt, response_structure=response_format)

            # ê²°ê³¼ íŒŒì‹±
            critic_response = json.loads(critic_response)
            critic_result = critic_response.get("critic", "")
            opinion = critic_response.get("opinion", False)
            revise = critic_response.get("revise", False)
            
            results = {
                "critic": critic_result,
                "opinion": opinion,  # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” critic_response íŒŒì‹± í•„ìš”
                "revise": revise
            }

        print(f"#### ğŸ“ CriticAgent ê²°ê³¼ : {results}")
        return results

